<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dex Coin Earner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #080808; color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; overflow-x: hidden; }
        .screen { display: none; padding-bottom: 90px; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        .top-bar { background: #111; padding: 25px 20px; text-align: center; border-bottom: 1px solid #222; border-radius: 0 0 25px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 10px; }
        .bal-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .bal-value { font-size: 38px; font-weight: 800; color: #ffcc00; margin: 5px 0; }
        .category-container { display: flex; justify-content: space-around; padding: 15px; gap: 10px; overflow-x: auto; }
        .cat-btn { background: #1a1a1a; border: 1px solid #333; color: #888; padding: 10px 18px; border-radius: 12px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .cat-btn.active { background: #ffcc00; color: #000; border: none; }
        .task-container { padding: 0 20px; }
        .task-group { display: none; }
        .task-group.active { display: block; }
        .task-card { background: #151515; border-radius: 20px; padding: 18px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #222; flex-wrap: wrap; }
        .icon-box { width: 45px; height: 45px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        .details { flex-grow: 1; }
        .details h4 { margin: 0; font-size: 15px; }
        .reward { color: #4cd137; font-weight: bold; font-size: 13px; margin-top: 4px; }
        .task-meta { font-size: 11px; color: #aaa; margin-top: 5px; line-height: 1.3; }
        .go-btn { background: #333; color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; min-width: 80px; transition: 0.2s; }
        .go-btn:disabled { background: #222; color: #777; cursor: not-allowed; pointer-events: none; }
        
        .proof-ui { width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; display: none; }
        .instruction-box { background: #1a1a1a; padding: 12px; border-radius: 10px; border-left: 4px solid #ffcc00; margin-bottom: 15px; font-size: 13px; color: #ddd; line-height: 1.4; }
        .instruction-box b { color: #ffcc00; display: block; margin-bottom: 5px; }
        .proof-input { width: 100%; padding: 12px; background: #080808; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 13px; }
        .submit-btn { background: #ffcc00; color: #000; border: none; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }

        #video-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .timer-box { background: #111; padding: 30px; border-radius: 25px; border: 2px solid #ffcc00; box-shadow: 0 0 20px rgba(255,204,0,0.2); }
        #timer-display { font-size: 40px; font-weight: bold; color: #ffcc00; margin-bottom: 10px; }
        .timer-msg { color: #888; font-size: 14px; margin-bottom: 20px; }
        #claim-btn { display: none; background: #4cd137; color: #000; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }

        .withdraw-input { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: #fff; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; font-size: 14px; }
        .withdraw-btn { width: 100%; background: #ffcc00; color: #000; border: none; padding: 18px; border-radius: 15px; font-weight: 800; font-size: 16px; cursor: pointer; }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; padding: 15px 0; border-top: 1px solid #222; z-index: 1000; }
        .nav-link { flex: 1; text-align: center; font-size: 22px; color: #444; cursor: pointer; }
        .nav-link.active { color: #ffcc00; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="video-overlay">
        <div class="timer-box">
            <div id="timer-display">0s</div>
            <p class="timer-msg">Watching video in new tab...<br>Don't close this screen!</p>
            <button id="claim-btn" onclick="collectVideoReward()">Claim Reward üéÅ</button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="top-bar">
            <div class="bal-label">Available Balance</div>
            <div class="bal-value"><span class="balance-text">0</span> DEX</div>
        </div>
        <div class="category-container">
            <div class="cat-btn active" onclick="showTaskGroup('videos', this)">üì∫ Videos</div>
            <div class="cat-btn" onclick="showTaskGroup('ads', this)">üñ±Ô∏è Ads</div>
            <div class="cat-btn" onclick="showTaskGroup('surveys', this)">üìù Surveys</div>
            <div class="cat-btn" onclick="showTaskGroup('minitasks', this)">üõ†Ô∏è Mini Tasks</div>
        </div>
        <div class="task-container">
            <div id="group-videos" class="task-group active">Loading...</div>
            <div id="group-ads" class="task-group">Loading...</div>
            <div id="group-surveys" class="task-group">Loading...</div>
            <div id="group-minitasks" class="task-group">Loading...</div>
        </div>
    </div>

    <div id="screen-wallet" class="screen">
        <div class="top-bar"><div class="bal-label">Wallet</div><div class="bal-value"><span class="balance-text">0</span> DEX</div></div>
        <div class="wallet-container" style="padding:20px;">
            <select id="method" class="withdraw-input">
                <option value="Binance ID">Binance ID</option>
                <option value="Bank Transfer">Bank Transfer (Sri Lanka Only)</option>
                <option value="Binance Wallet Address">Binance Wallet</option>
            </select>
            <input type="number" id="amount" placeholder="Amount (Minimum 1000)" class="withdraw-input">
            <textarea id="details" placeholder="Enter ID, Bank details or Address here..." class="withdraw-input" style="height: 100px;"></textarea>
            <button class="withdraw-btn" onclick="submitWithdraw()">Withdraw Now</button>
        </div>
    </div>

    <div class="nav">
        <div id="nav-home" class="nav-link active" onclick="switchScreen('home')">üè†</div>
        <div id="nav-wallet" class="nav-link" onclick="switchScreen('wallet')">üí∞</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD9_9m2VfkRLDRrwppORwbOVHfpp8lnFn8",
            authDomain: "my-telegram-task-app.firebaseapp.com",
            projectId: "my-telegram-task-app",
            storageBucket: "my-telegram-task-app.firebasestorage.app",
            messagingSenderId: "604214477570",
            appId: "1:604214477570:web:22158633ad5bff2b47b81b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let tg = window.Telegram.WebApp;
        tg.ready();
        let user = tg.initDataUnsafe.user || { id: "Guest_User", first_name: "Guest" };
        
        let balance = 0, completedTasks = [], activeTaskId = null, activeReward = 0;
        let isProcessing = false; // Double submission prevention

        function loadUserData() {
            db.collection("users").doc(user.id.toString()).onSnapshot(doc => {
                if (doc.exists) {
                    balance = doc.data().balance || 0;
                    completedTasks = doc.data().completedTasks || [];
                } else {
                    db.collection("users").doc(user.id.toString()).set({ name: user.first_name, balance: 0, completedTasks: [] });
                }
                updateUI();
                loadTasksFromFirebase();
            });
        }
        loadUserData();

        function loadTasksFromFirebase() {
            // 1. Task Requests (Videos/Ads/Surveys) Check
            db.collection("taskRequests").where("userId", "==", user.id).onSnapshot(reqSnap => {
                let pendingTasks = [];
                reqSnap.forEach(rdoc => { if(rdoc.data().status === "pending") pendingTasks.push(rdoc.data().taskId); });

                // 2. Mini Task Proofs Check (NEW FIX: Checking Mini Tasks too)
                db.collection("miniTaskProofs").where("userId", "==", user.id).onSnapshot(proofSnap => {
                    proofSnap.forEach(pdoc => { if(pdoc.data().status === "pending") pendingTasks.push(pdoc.data().taskId); });

                    // 3. Load Tasks
                    db.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
                        const groups = { videos: "", ads: "", surveys: "", minitasks: "" };
                        const icons = { videos: "‚ñ∂Ô∏è", ads: "üîó", surveys: "üìÑ", minitasks: "üõ†Ô∏è" };
                        
                        snap.forEach(doc => {
                            const t = doc.data();
                            const isDone = completedTasks.includes(doc.id);
                            const isPending = pendingTasks.includes(doc.id);
                            const isMini = t.category === 'minitasks';
                            const isSurvey = t.category === 'surveys';

                            const html = `<div class="task-card">
                                <div class="icon-box">${icons[t.category] || '‚ú®'}</div>
                                <div class="details">
                                    <h4>${t.title}</h4>
                                    <p class="reward">+${t.reward} DEX</p>
                                    ${(isSurvey && t.instructions) ? `<div class="task-meta">${t.instructions}</div>` : ''} 
                                </div>
                                <button id="btn-${doc.id}" class="go-btn" ${(isDone || isPending) ? 'disabled style="background:#222;"' : ''} 
                                    onclick="${isMini ? `toggleMiniSection('${doc.id}')` : `handleTaskAction('${t.link}', ${t.reward}, '${doc.id}', ${t.timer || 15}, '${t.category}')`}">
                                    ${isDone ? 'Done ‚úÖ' : (isPending ? 'Pending ‚è≥' : (isMini ? 'Open' : 'Go'))}
                                </button>
                                ${isMini ? `
                                <div id="mini-${doc.id}" class="proof-ui">
                                    <div class="instruction-box">
                                        <b>üìù Instructions:</b>
                                        ${t.instructions || "Follow the link and submit proof."}
                                    </div>
                                    <button class="go-btn" style="width:100%; margin-bottom:8px; background:#005cbf;" onclick="window.open('https://fex.net/', '_blank')">1. Upload Screenshot</button>
                                    <button class="go-btn" style="width:100%; margin-bottom:10px;" onclick="window.open('${t.link}', '_blank')">2. Complete Task</button>
                                    <input type="text" id="link-${doc.id}" placeholder="Paste proof link..." class="proof-input">
                                    <button class="submit-btn" onclick="submitMiniProof('${doc.id}')">Submit Link</button>
                                </div>` : ''}
                            </div>`;
                            if (groups[t.category] !== undefined) groups[t.category] += html;
                        });
                        
                        document.getElementById('group-videos').innerHTML = groups.videos || "No tasks.";
                        document.getElementById('group-ads').innerHTML = groups.ads || "No tasks.";
                        document.getElementById('group-surveys').innerHTML = groups.surveys || "No tasks.";
                        document.getElementById('group-minitasks').innerHTML = groups.minitasks || "No tasks.";
                    });
                });
            });
        }

        function toggleMiniSection(id) {
            const el = document.getElementById('mini-' + id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function submitMiniProof(taskId) {
            if (isProcessing) return; // Prevent double click
            const btn = event.target;
            const linkInput = document.getElementById('link-' + taskId);
            const proofUrl = linkInput.value;
            if (!proofUrl || !proofUrl.startsWith('http')) return tg.showAlert("Invalid link!");

            isProcessing = true;
            btn.disabled = true; btn.innerText = "Submitting...‚è≥";

            db.collection("miniTaskProofs").add({
                userId: user.id, userName: user.first_name, taskId: taskId, proofUrl: proofUrl, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                tg.showAlert("Proof Submitted! ‚úÖ");
                btn.innerText = "Submitted ‚úÖ";
                linkInput.value = "";
                toggleMiniSection(taskId);
                isProcessing = false;
            }).catch(() => {
                btn.disabled = false; btn.innerText = "Submit Link";
                tg.showAlert("Error. Try again!");
                isProcessing = false;
            });
        }

        function handleTaskAction(link, reward, id, timer, category) {
            if (completedTasks.includes(id) || isProcessing) return;
            activeTaskId = id; activeReward = reward;
            window.open(link, '_blank');
            if (category === "videos") showTimerOverlay(timer);
            else startExternalTimer(id, reward, timer);
        }

        function showTimerOverlay(timer) {
            const overlay = document.getElementById('video-overlay');
            const display = document.getElementById('timer-display');
            const claimBtn = document.getElementById('claim-btn');
            overlay.style.display = 'flex'; claimBtn.style.display = 'none';
            let timeLeft = timer; display.innerText = timeLeft + "s";
            let videoInterval = setInterval(() => {
                timeLeft--; display.innerText = timeLeft + "s";
                if (timeLeft <= 0) { clearInterval(videoInterval); display.innerText = "Complete!"; claimBtn.style.display = 'block'; }
            }, 1000);
        }

        function collectVideoReward() {
            document.getElementById('video-overlay').style.display = 'none';
            claimReward(activeReward, activeTaskId);
        }

        function startExternalTimer(id, reward, timer) {
            const btn = document.getElementById('btn-' + id);
            let timeLeft = timer; btn.disabled = true;
            const extTimer = setInterval(() => {
                timeLeft--; btn.innerText = timeLeft + "s";
                if (timeLeft <= 0) { 
                    clearInterval(extTimer); btn.innerText = "Claim"; btn.disabled = false; btn.style.background = "#4cd137";
                    btn.onclick = () => claimReward(reward, id);
                }
            }, 1000);
        }

        function claimReward(reward, taskId) {
            if (isProcessing) return;
            isProcessing = true;
            
            // Disable button immediately visually
            const btn = document.getElementById('btn-' + taskId);
            if(btn) { btn.innerText = "Pending ‚è≥"; btn.disabled = true; btn.style.background = "#444"; }

            db.collection("taskRequests").add({
                userId: user.id, userName: user.first_name, taskId: taskId, reward: reward, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                tg.showAlert("Reward Request Sent! ‚úÖ");
                tg.HapticFeedback.notificationOccurred('success');
                isProcessing = false;
            });
        }

        function submitWithdraw() {
            if (isProcessing) return;
            const amt = parseInt(document.getElementById('amount').value);
            const detail = document.getElementById('details').value;
            const meth = document.getElementById('method').value;
            if (amt < 1000 || balance < amt || !detail) return tg.showAlert("Check amount or details!");
            
            isProcessing = true;
            document.querySelector('.withdraw-btn').innerText = "Processing...";

            db.collection("withdrawals").add({ 
                userId: user.id, userName: user.first_name, amount: amt, method: meth, details: detail, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }).then(() => {
                tg.showAlert("Withdrawal Request Submitted! ‚úÖ");
                document.getElementById('amount').value = "";
                document.getElementById('details').value = "";
                document.querySelector('.withdraw-btn').innerText = "Withdraw Now";
                isProcessing = false;
            });
        }

        function switchScreen(s) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + s).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + s).classList.add('active');
        }

        function showTaskGroup(g, btn) {
            document.querySelectorAll('.task-group').forEach(el => el.classList.remove('active'));
            document.getElementById('group-' + g).classList.add('active');
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function updateUI() { document.querySelectorAll('.balance-text').forEach(el => el.innerText = balance); }
    </script>
</body>
</html>