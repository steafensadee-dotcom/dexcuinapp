<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dex Coin Earner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #080808; color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .screen { display: none; padding-bottom: 90px; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        .top-bar { background: #111; padding: 25px 20px; text-align: center; border-bottom: 1px solid #222; border-radius: 0 0 25px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 10px; }
        .bal-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .bal-value { font-size: 38px; font-weight: 800; color: #ffcc00; margin: 5px 0; }
        .category-container { display: flex; justify-content: space-around; padding: 15px; gap: 10px; overflow-x: auto; }
        .cat-btn { background: #1a1a1a; border: 1px solid #333; color: #888; padding: 10px 18px; border-radius: 12px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .cat-btn.active { background: #ffcc00; color: #000; border: none; }
        .task-container { padding: 0 20px; }
        .task-group { display: none; }
        .task-group.active { display: block; }
        .task-card { background: #151515; border-radius: 20px; padding: 18px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #222; flex-wrap: wrap; }
        .icon-box { width: 45px; height: 45px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        .details { flex-grow: 1; }
        .details h4 { margin: 0; font-size: 15px; }
        .reward { color: #4cd137; font-weight: bold; font-size: 13px; margin-top: 4px; }
        .task-meta { font-size: 11px; color: #aaa; margin-top: 5px; line-height: 1.3; }
        .go-btn { background: #333; color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; min-width: 80px; }
        .go-btn:disabled { background: #222 !important; color: #666 !important; cursor: not-allowed; pointer-events: none; }
        
        .proof-ui { width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; display: none; }
        .instruction-box { background: #1a1a1a; padding: 12px; border-radius: 10px; border-left: 4px solid #ffcc00; margin-bottom: 15px; font-size: 13px; color: #ddd; line-height: 1.4; }
        .instruction-box b { color: #ffcc00; display: block; margin-bottom: 5px; }
        .proof-input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 15px; outline: none; }
        .proof-input:focus { border-color: #ffcc00; }
        .submit-btn { background: #ffcc00; color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }

        #video-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .timer-box { background: #111; padding: 30px; border-radius: 25px; border: 2px solid #ffcc00; }
        #timer-display { font-size: 40px; font-weight: bold; color: #ffcc00; }
        #claim-btn { display: none; background: #4cd137; color: #000; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        .withdraw-input { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: #fff; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .withdraw-btn { width: 100%; background: #ffcc00; color: #000; border: none; padding: 18px; border-radius: 15px; font-weight: 800; font-size: 16px; cursor: pointer; }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; padding: 15px 0; border-top: 1px solid #222; }
        .nav-link { flex: 1; text-align: center; font-size: 22px; color: #444; cursor: pointer; }
        .nav-link.active { color: #ffcc00; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="video-overlay">
        <div class="timer-box">
            <div id="timer-display">0s</div>
            <p style="color:#888;">Watching video...<br>Please wait</p>
            <button id="claim-btn" onclick="collectVideoReward()">Claim Reward üéÅ</button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="top-bar">
            <div class="bal-label">Available Balance</div>
            <div class="bal-value"><span class="balance-text">0</span> DEX</div>
        </div>
        <div class="category-container">
            <div class="cat-btn active" onclick="showTaskGroup('videos', this)">üì∫ Videos</div>
            <div class="cat-btn" onclick="showTaskGroup('ads', this)">üñ±Ô∏è Ads</div>
            <div class="cat-btn" onclick="showTaskGroup('surveys', this)">üìù Surveys</div>
            <div class="cat-btn" onclick="showTaskGroup('minitasks', this)">üõ†Ô∏è Mini Tasks</div>
        </div>
        <div class="task-container">
            <div id="group-videos" class="task-group active">Loading...</div>
            <div id="group-ads" class="task-group">Loading...</div>
            <div id="group-surveys" class="task-group">Loading...</div>
            <div id="group-minitasks" class="task-group">Loading...</div>
        </div>
    </div>

    <div id="screen-wallet" class="screen">
        <div class="top-bar"><div class="bal-label">Wallet Balance</div><div class="bal-value"><span class="balance-text">0</span> DEX</div></div>
        <div style="padding:20px;">
            <select id="method" class="withdraw-input">
                <option value="Binance ID">Binance ID</option>
                <option value="Bank Transfer">Bank Transfer (SL Only)</option>
                <option value="Binance Wallet">Binance Wallet (USDT)</option>
            </select>
            <input type="number" id="amount" placeholder="Amount (Minimum 1000)" class="withdraw-input">
            <textarea id="details" placeholder="Enter Payment Details Here..." class="withdraw-input" style="height: 100px;"></textarea>
            <button class="withdraw-btn" onclick="submitWithdraw()">Withdraw Now</button>
        </div>
    </div>

    <div class="nav">
        <div id="nav-home" class="nav-link active" onclick="switchScreen('home')">üè†</div>
        <div id="nav-wallet" class="nav-link" onclick="switchScreen('wallet')">üí∞</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD9_9m2VfkRLDRrwppORwbOVHfpp8lnFn8",
            authDomain: "my-telegram-task-app.firebaseapp.com",
            projectId: "my-telegram-task-app",
            storageBucket: "my-telegram-task-app.firebasestorage.app",
            messagingSenderId: "604214477570",
            appId: "1:604214477570:web:22158633ad5bff2b47b81b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        let user = tg.initDataUnsafe.user || { id: "Guest_User", first_name: "Guest" };
        
        let balance = 0, completedTasks = [], pendingTasks = [], isProcessing = false;
        let activeTaskId = null, activeReward = 0;

        function initialTaskLoad() {
            db.collection("tasks").orderBy("createdAt", "desc").get().then(snap => {
                const groups = { videos: "", ads: "", surveys: "", minitasks: "" };
                const icons = { videos: "‚ñ∂Ô∏è", ads: "üîó", surveys: "üìÑ", minitasks: "üõ†Ô∏è" };
                snap.forEach(doc => {
                    const t = doc.data(); const id = doc.id;
                    const html = `<div class="task-card" id="card-${id}">
                        <div class="icon-box">${icons[t.category] || '‚ú®'}</div>
                        <div class="details"><h4>${t.title}</h4><p class="reward">+${t.reward} DEX</p></div>
                        <button id="btn-${id}" class="go-btn" onclick="handleBtnClick('${id}','${t.category}','${t.link}',${t.reward},${t.timer||15})">Go</button>
                        ${(t.category === 'minitasks') ? `<div id="mini-ui-${id}" class="proof-ui">
                            <div class="instruction-box"><b>üìù Instructions:</b> ${t.instructions || "Complete task and submit link."}</div>
                            <button class="go-btn" style="width:100%; margin-bottom:8px; background:#005cbf;" onclick="tg.openLink('https://fex.net/')">1. Upload Screenshot</button>
                            <button class="go-btn" style="width:100%; margin-bottom:10px;" onclick="tg.openLink('${t.link}')">2. Complete Task</button>
                            <input type="text" id="link-${id}" placeholder="Paste link here..." class="proof-input">
                            <button class="submit-btn" onclick="submitMiniProof('${id}')">Submit Link</button>
                        </div>` : ''}
                    </div>`;
                    if (groups[t.category] !== undefined) groups[t.category] += html;
                });
                Object.keys(groups).forEach(g => document.getElementById('group-' + g).innerHTML = groups[g] || "No tasks available.");
                loadUserData();
            });
        }
        initialTaskLoad();

        function loadUserData() {
            db.collection("users").doc(user.id.toString()).onSnapshot(doc => {
                if (doc.exists) {
                    balance = doc.data().balance || 0;
                    completedTasks = doc.data().completedTasks || [];
                    updateUI();
                    updateButtonStatuses();
                } else {
                    db.collection("users").doc(user.id.toString()).set({ name: user.first_name, balance: 0, completedTasks: [] });
                }
            });

            db.collection("taskRequests").where("userId", "==", user.id).onSnapshot(s => {
                let p = []; s.forEach(d => { if(d.data().status === "pending") p.push(d.data().taskId); });
                pendingTasks = p;
                updateButtonStatuses();
            });

            db.collection("miniTaskProofs").where("userId", "==", user.id).onSnapshot(s => {
                let p = [...pendingTasks]; s.forEach(d => { if(d.data().status === "pending") p.push(d.data().taskId); });
                pendingTasks = p;
                updateButtonStatuses();
            });
        }

        function updateButtonStatuses() {
            document.querySelectorAll('.go-btn[id^="btn-"]').forEach(btn => {
                const id = btn.id.replace('btn-', '');
                if (completedTasks.includes(id)) {
                    btn.innerText = "Done ‚úÖ"; btn.disabled = true;
                    hideMiniUI(id);
                } else if (pendingTasks.includes(id)) {
                    btn.innerText = "Pending ‚è≥"; btn.disabled = true;
                    hideMiniUI(id);
                }
            });
        }

        function hideMiniUI(id) {
            const ui = document.getElementById('mini-ui-' + id);
            if (ui && document.activeElement.id !== 'link-' + id) {
                ui.style.display = 'none';
            }
        }

        function handleBtnClick(id, cat, link, reward, timer) {
            if (cat === 'minitasks') {
                const ui = document.getElementById('mini-ui-' + id);
                const btn = document.getElementById('btn-' + id);
                if (ui.style.display === 'block') {
                    ui.style.display = 'none'; btn.innerText = "Open";
                } else {
                    ui.style.display = 'block'; btn.innerText = "Close";
                }
            } else {
                handleTaskAction(link, reward, id, timer, cat);
            }
        }

        function handleTaskAction(link, reward, id, timer, cat) {
            activeTaskId = id; activeReward = reward; tg.openLink(link);
            if (cat === "videos") {
                showTimerOverlay(timer);
            } else {
                startExtTimer(id, reward, timer);
            }
        }

        function showTimerOverlay(t) {
            const ov = document.getElementById('video-overlay');
            const disp = document.getElementById('timer-display');
            const clm = document.getElementById('claim-btn');
            ov.style.display = 'flex'; clm.style.display = 'none';
            let left = t; disp.innerText = left + "s";
            let iv = setInterval(() => {
                left--; disp.innerText = left + "s";
                if(left <= 0) { clearInterval(iv); disp.innerText = "Video Done!"; clm.style.display = 'block'; }
            }, 1000);
        }

        function collectVideoReward() {
            document.getElementById('video-overlay').style.display = 'none';
            claimReward(activeReward, activeTaskId);
        }

        function startExtTimer(id, r, t) {
            const btn = document.getElementById('btn-' + id);
            let left = t; btn.disabled = true;
            let iv = setInterval(() => {
                left--; btn.innerText = left + "s";
                if(left <= 0) {
                    clearInterval(iv); btn.innerText = "Claim"; btn.disabled = false;
                    btn.style.background = "#4cd137"; btn.style.color = "#000";
                    btn.onclick = () => claimReward(r, id);
                }
            }, 1000);
        }

        function claimReward(r, id) {
            if (isProcessing) return; 
            isProcessing = true;
            // ‡∂ë‡∂ö‡∂∏ ‡∂ß‡∑è‡∑É‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂ö‡∑í‡∑Ñ‡∑í‡∂¥ ‡∑Ä‡∂ª‡∂ö‡∑ä ‡∂ª‡∑í‡∂ö‡∑ä‡∑Ä‡∑ô‡∑É‡∑ä‡∂ß‡∑ä ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∑ê‡∂Ω‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ì‡∂∏‡∂ß Unique ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂∫‡∑í
            const requestId = user.id + "_" + id;
            db.collection("taskRequests").doc(requestId).set({
                userId: user.id, userName: user.first_name, taskId: id, reward: r, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                tg.showAlert("Reward Requested! ‚úÖ"); 
                isProcessing = false;
            }).catch(e => {
                isProcessing = false;
            });
        }

        function submitMiniProof(id) {
            if (isProcessing) return;
            const val = document.getElementById('link-' + id).value;
            if (!val.startsWith('http')) return tg.showAlert("Please paste a valid link!");
            isProcessing = true;
            const proofId = user.id + "_" + id;
            db.collection("miniTaskProofs").doc(proofId).set({
                userId: user.id, userName: user.first_name, taskId: id, proofUrl: val, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                tg.showAlert("Proof Submitted! ‚úÖ");
                document.getElementById('mini-ui-' + id).style.display = 'none';
                isProcessing = false;
            }).catch(e => {
                isProcessing = false;
            });
        }

        function submitWithdraw() {
            if (isProcessing) return;
            const amt = parseInt(document.getElementById('amount').value);
            const det = document.getElementById('details').value;
            if (amt < 1000 || balance < amt || !det) return tg.showAlert("Invalid input!");
            isProcessing = true;
            db.collection("withdrawals").add({
                userId: user.id, userName: user.first_name, amount: amt, method: document.getElementById('method').value, details: det, status: "pending", timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                tg.showAlert("Withdrawal Submitted! ‚úÖ"); isProcessing = false;
            }).catch(e => { isProcessing = false; });
        }

        function updateUI() { document.querySelectorAll('.balance-text').forEach(el => el.innerText = balance); }
        function switchScreen(s) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + s).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + s).classList.add('active');
        }
        function showTaskGroup(g, btn) {
            document.querySelectorAll('.task-group').forEach(el => el.classList.remove('active'));
            document.getElementById('group-' + g).classList.add('active');
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>
